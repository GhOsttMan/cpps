const path = require('path');

const rootPath = path.resolve(__dirname, '../../../');
const secretPath = path.join(rootPath, 'secret.js');

const secretModule = {
  secret: process.env.SECRET_TOKEN || require(secretPath).secret,
  dburl: process.env.MONGODB_URI || require(secretPath).dburl,
  sendGridAPI: process.env.SEND_GRID_API || require(secretPath).sendGridAPI,
  recaptcha: {
    site: process.env.RECAPTCHA_SITE || require(secretPath).recaptcha.site,
    secret: process.env.RECAPTCHA_SECRET || require(secretPath).recaptcha.secret
  }
};

module.exports = {
  rootPath,
  myRender,
  grabMiddleware,
  secretModule
};

function myRender(req, res, view, context = {}) {
  const sess = req.session || {};
  if (sess.login) {
    context.login = true;
    context.email = sess.email;
    context.status = sess.status;
  }

  const flashContext = req.flash('context');
  const len = flashContext.length;
  for (let i = 0; i < len; i++) {
    for (const val in flashContext[i]) {
      context[val] = flashContext[i][val];
    }
  }

  return res.render(view, context);
}

function grabMiddleware(name) {
  return require(path.join(rootPath, 'middlewares', name));
}
